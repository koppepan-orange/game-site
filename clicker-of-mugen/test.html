<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>直感で描けるメモ</title>
  <!-- Fabric.jsのCDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    body{
      margin: 0;
      padding: 0;
      font-family: sans-serif; 
    }

    canvas{
      border: 1px solid #000;
      display: block; margin: 0 auto;
    }
    button{
      margin: 5px;
    }

    #upperUI{
      height: calc(10vh - 20px);
      background: #ddd;;
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #upperUI .home{
      display: none;
    }
    #hontai{
      position: relative;
      border: 1px solid #ccc;
    }
    #tools{
      height: calc(10vh - 20px);
      background: #ddd;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    #tools button{
      height: 25px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <!-- 上部のUI：ユーザー名表示とログイン/ホームボタン -->
  <div id="upperUI">
    <span class="username">Username: Guest</span>
    <button class="login">ログイン</button>
    <button class="home">ホーム</button>
  </div>
  <!-- 中央：描画領域 -->
  <div id="hontai">
    <canvas id="c" width="600" height="800"></canvas>
  </div>
  <!-- 下部：ツールパネル -->
  <div id="tools">
    <button class="cpToddle">カーソルモード</button>
    <button class="peToggle">ペン/消しゴム切替</button>
    <button class="color">ペンの色変更</button>
    <button class="textbox">テキストボックス生成</button>
    <button class="zoomIn">ズームイン</button>
    <button class="zoomOut">ズームアウト</button>
  </div>

  <script>
    // Fabric.jsキャンバス初期化
    let canvas = new fabric.Canvas('c', { selection: false });
    let isDrawingMode = false;
    let isPenMode = true; // true: ペン, false: 消しゴム（ここでは白色で描画）
    let currentColor = '#000000';
    let backgroundColor = '#ffffff';
    let zoomLevel = 1;

    // 初期の描画設定
    canvas.backgroundColor = backgroundColor;
    canvas.isDrawingMode = false;
    canvas.freeDrawingBrush.width = 3;
    canvas.freeDrawingBrush.color = currentColor;

    // モード切替ボタン：描画モードと選択モードをトグル
    document.querySelector('#tools .cpToddle').addEventListener('click', function(){
      isDrawingMode = !isDrawingMode;
      canvas.isDrawingMode = isDrawingMode;
      this.textContent = isDrawingMode ? 'ペンモード' : 'カーソルモード';
    });

    // ペン/消しゴム切替（消しゴムは単純に白で線を描く）
    document.querySelector('#tools .peToggle').addEventListener('click', function(){
      isPenMode = !isPenMode;
      if(isPenMode){
        canvas.freeDrawingBrush.color = currentColor;
        alert('ペンに切り替え');
      } else {
        canvas.freeDrawingBrush.color = backgroundColor;
        alert('消しゴムに切り替え');
      }
    });

    // ペンの色変更
    document.querySelector('#tools .color').addEventListener('click', function(){
      let newColor = prompt('新しいペンの色を入力してね(例:#ff0000)');
      if(newColor){
        currentColor = newColor;
        if(isPenMode) {
          canvas.freeDrawingBrush.color = currentColor;
        }
      }
    });

    // テキストボックス生成
    document.querySelector('#tools .textbox').addEventListener('click', function(){
      let textbox = new fabric.Textbox('テキストを入力してね', {
        left: 50,
        top: 50,
        width: 150,
        fontSize: 20,
        editable: false  // 初期は編集不可、カーソルモードでダブルクリック時に編集可にする
      });
      canvas.add(textbox);
    });

    // ダブルクリックでテキストボックス編集（カーソルモード時のみ）
    canvas.on('mouse:dblclick', function(options){
      if(options.target && options.target.type === 'textbox'){
        if(!canvas.isDrawingMode){
          options.target.set('editable', true);
          canvas.setActiveObject(options.target);
          options.target.enterEditing();
          canvas.renderAll();
        }
      }
    });

    // ズームイン/ズームアウト機能
    document.querySelector('#tools .zoomIn').addEventListener('click', function(){
      zoomLevel *= 1.1;
      canvas.setZoom(zoomLevel);
    });
    document.querySelector('#tools .zoomOut').addEventListener('click', function(){
      zoomLevel /= 1.1;
      canvas.setZoom(zoomLevel);
    });

    // ログインシミュレーション
    document.querySelector('#upperUI .login').addEventListener('click', function(){
      let username = prompt('ユーザー名を入力してね');
      if(username){
        document.querySelector('#upperUI .username').textContent = 'Username: ' + username;
        this.style.display = 'none';
        document.querySelector('#upperUI .home').style.display = 'inline';
      }
    });

    // ホームボタン（Firebase連携などはここで実装する）
    document.querySelector('#upperUI .home').addEventListener('click', function(){
      alert('ホーム画面へ。ここに保存されたメモ一覧表示処理を実装しなさい。');
    });
  </script>
</body>
</html>