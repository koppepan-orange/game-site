<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grokã®å…¨åŠ›RPGï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰</title>
<style>
  :root{--bg:#f7fafc;--card:#fff;--muted:#999}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:980px;margin:28px auto;padding:18px;display:grid;gap:16px}
  header h1{margin:0;font-size:24px}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(12,12,12,0.06)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .bar{height:10px;background:#e6e6e6;border-radius:999px;overflow:hidden}
  .hpfill{height:100%;background:linear-gradient(90deg,#34d399,#10b981)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button{cursor:pointer;border:0;padding:8px 12px;border-radius:12px;background:#111;color:#fff}
  button.gray{background:#333}
  button.indigo{background:#4f46e5}
  button.disabled{opacity:.4;cursor:default}
  .small{font-size:13px;color:var(--muted)}
  .log{max-height:250px;overflow:auto;font-size:14px;line-height:1.6}
  .monster-sprite{display:flex;align-items:center;justify-content:center;height:120px}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#fde2e2;color:#b91c1c;font-size:12px}
  .right-small{font-size:13px;color:#666}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
  .muted{color:var(--muted)}
  .skillbtn{background:#fff;color:#111;border:1px solid #ddd;padding:8px;border-radius:10px;cursor:pointer}
  .skillbtn.disabled{opacity:.45;cursor:default}
  footer{font-size:12px;color:#666;text-align:center;margin-top:8px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Grokã®å…¨åŠ›RPGï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼‰</h1>
    <div class="small muted">Reactãªã—ã§å‹•ãã‚ˆã†ã«ç›´ã—ã¦ã‚ã‚‹ã€‚å‹æ‰‹ã«æ”¹é€ ã—ã¦ã‚‚è‰¯ã„ã€‚</div>
  </header>

  <div id="start-area" class="card">
    <div class="flex-between">
      <div style="flex:1;margin-right:8px">
        <div class="small">åå‰ã‚’å…¥åŠ›ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹</div>
        <input id="name-input" type="text" placeholder="å‹‡è€…å"/>
      </div>
      <div style="width:140px">
        <button id="start-btn">é–‹å§‹</button>
      </div>
    </div>
  </div>

  <div id="game-area" style="display:none" class="card">
    <div class="grid2">
      <div id="player-card" class="card" style="padding:12px">
        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
        <div id="player-status" class="small muted">--</div>
        <div style="margin-top:8px" class="small">ã‚¯ãƒªç‡ <span id="crit-rate">0%</span> / ã‚¯ãƒªå€ç‡ x<span id="crit-mul">1.5</span></div>
        <div style="margin-top:8px" class="small">ã‚¢ã‚¤ãƒ†ãƒ : ãƒãƒ¼ã‚·ãƒ§ãƒ³ x<span id="potions">0</span> / ã‚¨ãƒªã‚¯ã‚µãƒ¼ x<span id="elixirs">0</span></div>
        <div style="margin-top:12px" class="bar"><div id="player-hp" class="hpfill" style="width:100%"></div></div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap" id="skill-list"></div>
      </div>

      <div id="enemy-card" class="card" style="padding:12px">
        <h3>æ•µ</h3>
        <div class="monster-sprite" id="monster-sprite">--</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div id="monster-name">--</div>
          <div id="monster-status"></div>
        </div>
        <div style="margin-top:8px" class="small" id="monster-hp-txt">--</div>
        <div style="margin-top:6px" class="bar"><div id="monster-hp" class="hpfill" style="width:100%"></div></div>
        <div style="margin-top:8px" class="small">æ¬¡ã®è¡Œå‹•: <strong id="monster-intent">--</strong></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;padding:12px">
      <div class="actions" id="action-row">
        <button id="btn-attack">æ”»æ’ƒ</button>
        <button id="btn-guard" class="gray">é˜²å¾¡</button>
        <button id="btn-skill" class="indigo">ã‚¹ã‚­ãƒ«</button>
        <button id="btn-item" class="gray">ãƒãƒ¼ã‚·ãƒ§ãƒ³</button>
        <button id="btn-elixir" class="gray">ã‚¨ãƒªã‚¯ã‚µãƒ¼</button>
        <div style="margin-left:auto" class="right-small">é€²æ—: <span id="progress">0/0</span> ä½“æ’ƒç ´</div>
      </div>

      <div id="skills-panel" style="display:none;margin-top:12px"></div>
    </div>

    <div class="card" style="margin-top:12px;padding:12px">
      <div class="log" id="log"></div>
    </div>

    <div id="end-area" style="display:none;margin-top:12px" class="card">
      <div id="end-text">--</div>
      <div style="margin-top:8px;text-align:right">
        <button id="reset-btn" class="gray">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
  </div>

  <footer>å‹•ä½œãŒãƒ˜ãƒ³ãªã‚‰ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ©ãƒ¼ã‚’è²¼ã‚Œã€‚ç›´ã—ã¦ã‚„ã‚‹ã€‚</footer>
</div>

<script>
/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min }
const chance = p => Math.random() < p;
const clone = v => JSON.parse(JSON.stringify(v));

/* ---------- åˆæœŸãƒ‡ãƒ¼ã‚¿ ---------- */
function initialPlayer(name){
  return {
    name: name||'å‹‡è€…',
    level:1,
    hp:100,
    maxHp:100,
    attack:20,
    defense:5,
    exp:0,
    expToNext:50,
    items: { 'ãƒãƒ¼ã‚·ãƒ§ãƒ³':3, 'ã‚¨ãƒªã‚¯ã‚µãƒ¼':0 },
    skills: {
      'å¼·æ’ƒ': { cd:0, baseCd:2, desc:'å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸+25%ã§é˜²å¾¡ä½ä¸‹(2T)' },
      'ç™’ã—': { cd:0, baseCd:3, desc:'HPã‚’ä¸­å›å¾©' }
    },
    effects: { guard:0, atkUp:0 },
    critRate:0.15,
    critMul:1.5
  };
}

function initialMonsters(){
  return [
    { name:'ã‚¹ãƒ©ã‚¤ãƒ ', hp:50, maxHp:50, attack:10, defense:2, expReward:20, intent:'é€šå¸¸æ”»æ’ƒ', turn:0, effects:{ defDown:0, defBuff:0 } },
    { name:'ã‚´ãƒ–ãƒªãƒ³', hp:80, maxHp:80, attack:15, defense:5, expReward:30, intent:'æ§˜å­è¦‹', turn:0, effects:{ defDown:0, defBuff:0 } },
    { name:'ãƒ‰ãƒ©ã‚´ãƒ³', hp:120, maxHp:120, attack:25, defense:8, expReward:50, intent:'åŠ›ã‚’æºœã‚ã¦ã„ã‚‹â€¦', turn:0, effects:{ defDown:0, defBuff:0 } }
  ];
}

/* ---------- æç”»ç”¨ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«SVGï¼‰ ---------- */
function getMonsterSVG(name){
  if(name == 'ã‚¹ãƒ©ã‚¤ãƒ ') return `<svg viewBox="0 0 120 90" width="220" height="90"><path d="M10 60 Q60 5 110 60 Q100 85 60 85 Q20 85 10 60 Z" fill="#06b6d4"/><ellipse cx="45" cy="55" rx="6" ry="10" fill="#071023"/><ellipse cx="75" cy="55" rx="6" ry="10" fill="#071023"/><path d="M40 68 Q60 75 80 68" stroke="#071023" stroke-width="4" fill="none"/></svg>` 
  if(name == 'ã‚´ãƒ–ãƒªãƒ³') return `<svg viewBox="0 0 140 120" width="260" height="120"><g fill="#84cc16"><path d="M15 45 L55 25 Q70 55 55 75 Z"/><path d="M125 45 L85 25 Q70 55 85 75 Z"/><circle cx="70" cy="60" r="38"/></g><g fill="#071023"><circle cx="55" cy="60" r="6"/><circle cx="85" cy="60" r="6"/></g><path d="M50 85 Q70 95 90 85" stroke="#071023" stroke-width="5" fill="none"/></svg>` 
  if(name == 'ãƒ‰ãƒ©ã‚´ãƒ³') return `<svg viewBox="0 0 200 120" width="320" height="120"><g fill="#fb7185"><path d="M30 90 Q80 20 150 90 Z"/><circle cx="160" cy="60" r="18"/></g><g fill="#071023"><circle cx="155" cy="55" r="3"/><circle cx="165" cy="55" r="3"/></g><path d="M150 70 Q160 78 170 70" stroke="#071023" stroke-width="4" fill="none"/></svg>` 
  return '--';
}

/* ---------- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆ ---------- */
let player = initialPlayer('');
let monsters = initialMonsters();
let mi = 0;
let started = false;
let playerTurn = true;
let gameOver = false;
let gameClear = false;
let logArr = [];

/* ---------- DOMå‚ç…§ ---------- */
const el = id => document.getElementById(id);
const $nameInput = el('name-input');
const $startBtn = el('start-btn');
const $startArea = el('start-area');
const $gameArea = el('game-area');
const $playerStatus = el('player-status');
const $playerHp = el('player-hp');
const $monsterName = el('monster-name');
const $monsterStatus = el('monster-status');
const $monsterSprite = el('monster-sprite');
const $monsterHpTxt = el('monster-hp-txt');
const $monsterHp = el('monster-hp');
const $monsterIntent = el('monster-intent');
const $critRate = el('crit-rate');
const $critMul = el('crit-mul');
const $potions = el('potions');
const $elixirs = el('elixirs');
const $skillList = el('skill-list');
const $skillsPanel = el('skills-panel');
const $btnAttack = el('btn-attack');
const $btnGuard = el('btn-guard');
const $btnSkill = el('btn-skill');
const $btnItem = el('btn-item');
const $btnElixir = el('btn-elixir');
const $log = el('log');
const $progress = el('progress');
const $endArea = el('end-area');
const $endText = el('end-text');
const $resetBtn = el('reset-btn');

/* ---------- ãƒ˜ãƒ«ãƒ‘é–¢æ•° ---------- */
function pushLog(line){
  logArr.push('â€¢ ' + line);
  renderLog();
}
function renderLog(){
  $log.innerHTML = logArr.join('<br>');
  $log.scrollTop = $log.scrollHeight;
}
function calcDamage(atk, def, opts={}){
  const variance = randInt(-5,10);
  let raw = Math.max(1, atk + variance - def);
  if(opts.mult) raw = Math.max(1, Math.floor(raw * opts.mult));
  if(opts.pierce) raw = Math.max(1, Math.floor((atk + variance) * (opts.mult||1)));
  if(opts.canCrit && Math.random() < player.critRate){
    raw = Math.floor(raw * player.critMul);
    pushLog('ğŸ”¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆï¼');
  }
  return raw;
}
function tickCooldowns(skills){
  const next = clone(skills);
  Object.keys(next).forEach(k => { if(next[k].cd>0) next[k].cd -= 1 });
  return next;
}
function planEnemyIntent(m){
  const next = clone(m);
  next.turn = (next.turn||0) + 1;
  if(next.name==='ã‚¹ãƒ©ã‚¤ãƒ ') next.intent = 'ãƒ—ãƒ«ãƒ—ãƒ«æ”»æ’ƒ';
  else if(next.name==='ã‚´ãƒ–ãƒªãƒ³') next.intent = (chance(0.3) ? 'ã‚¬ãƒ¼ãƒ‰' : 'çŸ­å‰£æ”»æ’ƒ');
  else if(next.name==='ãƒ‰ãƒ©ã‚´ãƒ³') next.intent = (next.turn % 3 === 0 ? 'ç¼ç†±ã®ãƒ–ãƒ¬ã‚¹' : 'çˆªæ”»æ’ƒ');
  return next;
}

/* ---------- ã‚²ãƒ¼ãƒ å‡¦ç† ---------- */
function startGame(){
  const name = ($nameInput.value || 'å‹‡è€…').trim();
  player = initialPlayer(name);
  monsters = initialMonsters();
  mi = 0;
  playerTurn = true;
  started = true;
  gameOver = false;
  gameClear = false;
  logArr = [];
  pushLog(`ğŸŒŸ Grokã®å…¨åŠ›RPGã¸ã‚ˆã†ã“ãï¼ ${player.name}ã€æº–å‚™ã¯ã„ã„ï¼Ÿ`);
  pushLog(`ğŸ—¡ï¸ æˆ¦é—˜é–‹å§‹ï¼ ${monsters[0].name} ãŒç¾ã‚ŒãŸï¼`);
  $startArea.style.display = 'none';
  $gameArea.style.display = 'block';
  $endArea.style.display = 'none';
  renderAll();
  monsters[0] = planEnemyIntent(monsters[0]); // intentåˆæœŸåŒ–
}

function resetGame(){
  $startArea.style.display = '';
  $gameArea.style.display = 'none';
  $endArea.style.display = 'none';
  $nameInput.value = '';
  player = initialPlayer('');
  monsters = initialMonsters();
  mi = 0;
  started = false;
  logArr = [];
  renderAll();
}

function renderAll(){
  // player
  $playerStatus.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${player.name} (Lv.${player.level}) HP: ${player.hp}/${player.maxHp} æ”»:${player.attack} é˜²:${player.defense}` + (player.effects.guard ? ` [é˜²å¾¡+${player.effects.guard}]` : '');
  $playerHp.style.width = Math.max(0, (player.hp/player.maxHp)*100) + '%';
  $critRate.textContent = Math.round(player.critRate*100) + '%';
  $critMul.textContent = player.critMul;
  $potions.textContent = player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³']||0;
  $elixirs.textContent = player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼']||0;

  // skill list small badges
  $skillList.innerHTML = '';
  Object.entries(player.skills).forEach(([k,v])=>{
    const span = document.createElement('span');
    span.className = 'small muted';
    span.textContent = v.cd>0 ? `${k}(${v.cd})` : k;
    $skillList.appendChild(span);
  });

  // monster
  const m = monsters[mi];
  if(m){
    $monsterSprite.innerHTML = getMonsterSVG(m.name);
    $monsterName.textContent = m.name;
    $monsterStatus.innerHTML = (m.effects?.defDown>0? `<span class="badge">é˜²å¾¡ä½ä¸‹(${m.effects.defDown})</span>` : '');
    $monsterHpTxt.textContent = `${m.name} HP: ${m.hp}/${m.maxHp}`;
    $monsterHp.style.width = Math.max(0,(m.hp/m.maxHp)*100) + '%';
    $monsterIntent.textContent = m.intent || '--';
  } else {
    $monsterSprite.innerHTML = '--';
    $monsterName.textContent = '--';
    $monsterHpTxt.textContent = '--';
    $monsterHp.style.width = '0%';
    $monsterIntent.textContent = '--';
  }

  // actions enable/disable
  const disabled = !playerTurn || gameOver || gameClear;
  setDisabled($btnAttack, disabled);
  setDisabled($btnGuard, disabled);
  setDisabled($btnSkill, disabled);
  setDisabled($btnItem, disabled || (player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³']||0)<=0);
  setDisabled($btnElixir, disabled || (player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼']||0)<=0);

  // skills panel
  renderSkillsPanel();

  // progress
  $progress.textContent = `${mi}/${monsters.length}`;

  renderLog();

  // end area
  if(gameOver || gameClear){
    $endArea.style.display = 'block';
    $endText.textContent = gameOver ? 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹ï¼Ÿ' : `ã‚¯ãƒªã‚¢ï¼ æœ€çµ‚ãƒ¬ãƒ™ãƒ«: ${player.level}`;
  } else {
    $endArea.style.display = 'none';
  }
}

function setDisabled(elm, flag){
  if(flag){ elm.classList.add('disabled'); elm.setAttribute('disabled',''); }
  else { elm.classList.remove('disabled'); elm.removeAttribute('disabled'); }
}

function renderSkillsPanel(){
  $skillsPanel.innerHTML = '';
  Object.entries(player.skills).forEach(([k,v])=>{
    const btn = document.createElement('button');
    btn.className = 'skillbtn' + (v.cd>0 || !playerTurn ? ' disabled' : '');
    btn.textContent = `${k} ${v.cd>0?`(CD:${v.cd})`:''}`;
    const desc = document.createElement('div');
    desc.className = 'small muted';
    desc.style.marginTop = '4px';
    desc.textContent = v.desc;
    btn.onclick = () => { if(v.cd>0 || !playerTurn) return; onSkill(k) };
    const wrap = document.createElement('div');
    wrap.style.marginRight = '8px';
    wrap.appendChild(btn);
    wrap.appendChild(desc);
    $skillsPanel.appendChild(wrap);
  });
}

/* ---------- ã‚¿ãƒ¼ãƒ³å‡¦ç† ---------- */
function doEnemyTurn(){
  const m = monsters[mi];
  if(!m) return;
  // enemy action
  if(m.name==='ã‚´ãƒ–ãƒªãƒ³' && m.intent==='ã‚¬ãƒ¼ãƒ‰'){
    pushLog('ğŸ›¡ï¸ ã‚´ãƒ–ãƒªãƒ³ã¯èº«æ§‹ãˆã¦é˜²å¾¡ã‚’å›ºã‚ãŸï¼ æ¬¡ã®è¢«ãƒ€ãƒ¡-50%ã€‚');
    monsters[mi].effects.defBuff = Math.max(monsters[mi].effects.defBuff||0, 6);
    // no damage this turn
    setTimeout(()=>{ applyEndOfRound(); playerTurn = true; renderAll(); }, 100);
    return;
  }
  if(m.name==='ãƒ‰ãƒ©ã‚´ãƒ³' && m.intent==='ç¼ç†±ã®ãƒ–ãƒ¬ã‚¹'){
    const actual = calcDamage(m.attack + 10, 0, { mult:1.4, pierce:true });
    player.hp = Math.max(0, player.hp - actual);
    pushLog(`ğŸ”¥ ${m.name}ã®${m.intent}ï¼ ${player.name}ã«${actual}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ï¼ˆé˜²å¾¡ç„¡è¦–ï¼‰`);
    setTimeout(()=>{ if(player.hp<=0){ pushLog(`ğŸ’€ ${player.name}ãŒå€’ã‚ŒãŸ... ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼`); gameOver = true; renderAll(); } else { applyEndOfRound(); playerTurn = true; renderAll(); } }, 100);
    return;
  }
  // normal attack
  const defBonus = player.effects.guard || 0;
  const actual = calcDamage(m.attack, player.defense + defBonus);
  player.hp = Math.max(0, player.hp - actual);
  pushLog(`${m.name}ã®æ”»æ’ƒï¼ ${player.name}ã«${actual}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  setTimeout(()=>{ if(player.hp<=0){ pushLog(`ğŸ’€ ${player.name}ãŒå€’ã‚ŒãŸ... ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼`); gameOver = true; renderAll(); } else { applyEndOfRound(); playerTurn = true; renderAll(); } }, 100);
}

function applyEndOfRound(){
  // tick player skill cooldowns & clear guard
  player.skills = tickCooldowns(player.skills);
  if(player.effects.guard > 0) player.effects.guard = 0;
  // reduce monster defDown and clear defBuff after it applied for one turn
  if(monsters[mi]){
    if(monsters[mi].effects.defDown > 0) monsters[mi].effects.defDown -= 1;
    monsters[mi].effects.defBuff = 0;
    monsters[mi] = planEnemyIntent(monsters[mi]);
  }
}

/* ---------- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹• ---------- */
function onAttack(){
  if(!playerTurn || gameOver || gameClear) return;
  const m = monsters[mi];
  if(!m) return;
  const defDown = m.effects.defDown || 0;
  const actual = calcDamage(player.attack, Math.max(0, m.defense - defDown), { canCrit:true });
  const remaining = Math.max(0, m.hp - actual);
  monsters[mi].hp = remaining;
  pushLog(`${player.name}ã®æ”»æ’ƒï¼ ${m.name}ã«${actual}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
  playerTurn = false;
  setTimeout(()=> afterPlayerAction(actual, remaining), 80);
}
function onGuard(){
  if(!playerTurn || gameOver || gameClear) return;
  const bonus = randInt(6,12);
  player.effects.guard = bonus;
  pushLog(`${player.name}ã¯é˜²å¾¡ï¼ ã“ã®ã‚¿ãƒ¼ãƒ³é˜²å¾¡+${bonus}`);
  playerTurn = false;
  setTimeout(()=> afterPlayerAction(0, monsters[mi]?.hp ?? 0), 80);
}
function onUseItem(){
  if(!playerTurn || gameOver || gameClear) return;
  const pot = player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³']||0;
  if(pot<=0){ pushLog('ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ï¼'); return; }
  const heal = randInt(30,50);
  player.hp = Math.min(player.maxHp, player.hp + heal);
  player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³'] = pot-1;
  pushLog(`ğŸ§ª ãƒãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼ HPãŒ${heal}å›å¾©ã—ãŸã€‚æ®‹ã‚Š: ${pot-1}å€‹`);
  playerTurn = false;
  setTimeout(()=> afterPlayerAction(0, monsters[mi]?.hp ?? 0), 80);
}
function onUseElixir(){
  if(!playerTurn || gameOver || gameClear) return;
  const ex = player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼']||0;
  if(ex<=0){ pushLog('ã‚¨ãƒªã‚¯ã‚µãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼'); return; }
  player.hp = player.maxHp;
  player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼'] = ex-1;
  pushLog(`âœ¨ ã‚¨ãƒªã‚¯ã‚µãƒ¼ä½¿ç”¨ï¼ HPãŒå…¨å›å¾©ã—ãŸã€‚æ®‹ã‚Š: ${ex-1}å€‹`);
  playerTurn = false;
  setTimeout(()=> afterPlayerAction(0, monsters[mi]?.hp ?? 0), 80);
}
function onSkill(name){
  if(!playerTurn || gameOver || gameClear) return;
  const m = monsters[mi];
  if(!m) return;
  const s = player.skills[name];
  if(!s || s.cd>0) return;
  if(name==='å¼·æ’ƒ'){
    const defDown = m.effects.defDown || 0;
    const actual = calcDamage(player.attack + 8, Math.max(0, m.defense - defDown), { canCrit:true, mult:1.2 });
    const remaining = Math.max(0, m.hp - actual);
    monsters[mi].hp = remaining;
    if(chance(0.25)){
      monsters[mi].effects.defDown = Math.max(monsters[mi].effects.defDown||0, 2);
      pushLog('â¬‡ï¸ é˜²å¾¡ä½ä¸‹ã‚’ä»˜ä¸ï¼(2T)');
    }
    pushLog(`ğŸ’¥ ã‚¹ã‚­ãƒ«: å¼·æ’ƒï¼ ${m.name}ã«${actual}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    player.skills['å¼·æ’ƒ'].cd = player.skills['å¼·æ’ƒ'].baseCd;
    playerTurn = false;
    setTimeout(()=> afterPlayerAction(actual, remaining), 80);
    return;
  }
  if(name==='ç™’ã—'){
    const heal = randInt(35,55);
    player.hp = Math.min(player.maxHp, player.hp + heal);
    player.skills['ç™’ã—'].cd = player.skills['ç™’ã—'].baseCd;
    pushLog(`ğŸŒ¿ ã‚¹ã‚­ãƒ«: ç™’ã—ï¼ HPãŒ${heal}å›å¾©ã—ãŸã€‚`);
    playerTurn = false;
    setTimeout(()=> afterPlayerAction(0, monsters[mi]?.hp ?? 0), 80);
    return;
  }
}

/* ---------- çµŒé¨“å€¤ãƒ»æ’ƒç ´å‡¦ç† ---------- */
function gainExp(amount){
  player.exp += amount;
  pushLog(`çµŒé¨“å€¤ +${amount}ï¼ åˆè¨ˆEXP: ${player.exp}/${player.expToNext}`);
  if(player.exp >= player.expToNext){
    player.exp = 0;
    levelUp();
  }
}
function levelUp(){
  player.level += 1;
  player.maxHp += 20;
  player.hp = player.maxHp;
  player.attack += 5;
  player.defense += 2;
  player.expToNext += 30;
  pushLog(`ğŸ‰ ${player.name}ã¯ãƒ¬ãƒ™ãƒ«${player.level}ã«ä¸ŠãŒã£ãŸï¼ èƒ½åŠ›ãŒæˆé•·ã—ãŸï¼`);
}

function afterPlayerAction(playerDealt, remainingHp){
  const m = monsters[mi];
  const curRem = (typeof remainingHp === 'number') ? remainingHp : (m ? m.hp : 0);
  if(m && curRem <= 0){
    pushLog(`ğŸ¯ ${m.name}ã‚’å€’ã—ãŸï¼`);
    gainExp(m.expReward);
    const dropPot = chance(0.3);
    const dropElixir = chance(0.1);
    if(dropPot || dropElixir){
      if(dropPot) player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³'] = (player.items['ãƒãƒ¼ã‚·ãƒ§ãƒ³']||0) + 1;
      if(dropElixir) player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼'] = (player.items['ã‚¨ãƒªã‚¯ã‚µãƒ¼']||0) + 1;
      pushLog(`ğŸ æˆ¦åˆ©å“: ${dropPot ? 'ãƒãƒ¼ã‚·ãƒ§ãƒ³+1 ' : ''}${dropElixir ? 'ã‚¨ãƒªã‚¯ã‚µãƒ¼+1' : ''}`);
    }
    const nextIndex = mi + 1;
    if(nextIndex >= monsters.length){
      pushLog(`ğŸ† ãŠã‚ã§ã¨ã†ï¼ ${player.name}ã¯ã™ã¹ã¦ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å€’ã—ãŸï¼ æœ€çµ‚ãƒ¬ãƒ™ãƒ«: ${player.level}`);
      gameClear = true;
      renderAll();
      return;
    }
    // æ¬¡ã®æ•µã¸
    setTimeout(()=>{
      mi = nextIndex;
      monsters[mi] = planEnemyIntent(monsters[mi]);
      playerTurn = true;
      renderAll();
      pushLog(`ğŸ—¡ï¸ æˆ¦é—˜é–‹å§‹ï¼ ${monsters[mi].name} ãŒç¾ã‚ŒãŸï¼`);
    }, 150);
  } else {
    // æ•µã‚¿ãƒ¼ãƒ³
    renderAll();
    setTimeout(()=>{ doEnemyTurn(); renderAll(); }, 150);
  }
}

/* ---------- ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ ---------- */
$startBtn.addEventListener('click', ()=>startGame());
$resetBtn.addEventListener('click', ()=>{ resetGame(); });
$btnAttack.addEventListener('click', ()=>onAttack());
$btnGuard.addEventListener('click', ()=>onGuard());
$btnItem.addEventListener('click', ()=>onUseItem());
$btnElixir.addEventListener('click', ()=>onUseElixir());
$btnSkill.addEventListener('click', ()=>{
  $skillsPanel.style.display = ($skillsPanel.style.display === 'none' ? 'block' : 'none');
});

/* ---------- åˆæœŸæç”» ---------- */
renderAll();

/* ---------- ãƒ‡ãƒãƒƒã‚°è£œåŠ©ï¼ˆé–‹ç™ºæ™‚ã®ã¿ã€ä¸è¦ãªã‚‰æ¶ˆã™ï¼‰ ---------- */
// window._state = () => ({ player, monsters, mi, playerTurn, gameOver, gameClear, logArr });
</script>
</body>
</html>
